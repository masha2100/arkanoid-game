name: Python CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ‚¨áÔ∏è Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
      uses: actions/checkout@v3

    - name: üêç –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: üì¶ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html flake8 flake8-html

    - name: ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏ –∑ HTML-–∑–≤—ñ—Ç–æ–º
      run: |
        mkdir -p test-reports
        pytest --html=test-reports/report.html --self-contained-html || echo "::set-output name=test_status::‚ùå –¢–µ—Å—Ç–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω–æ"
      id: run_tests

    - name: üßπ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∏–ª—é –∫–æ–¥—É –∑ flake8
      run: |
        mkdir -p lint-reports
        flake8 . --format=html --htmldir=lint-reports || echo "::set-output name=lint_status::‚ö†Ô∏è –õ—ñ–Ω—Ç—ñ–Ω–≥ –∑–Ω–∞–π—à–æ–≤ –ø—Ä–æ–±–ª–µ–º–∏"
      id: run_lint

    - name: üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ —Ç–µ—Å—Ç–∏
      uses: actions/upload-artifact@v4
      with:
        name: pytest-report
        path: test-reports/

    - name: üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ –ª—ñ–Ω—Ç—ñ–Ω–≥
      uses: actions/upload-artifact@v4
      with:
        name: flake8-report
        path: lint-reports/

    - name: üìù –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä –¥–æ Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GH_TOKEN }}
        script: |
          const testStatus = "‚úÖ –¢–µ—Å—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ";
          const lintStatus = "‚úÖ –õ—ñ–Ω—Ç—ñ–Ω–≥ —É—Å–ø—ñ—à–Ω–∏–π (–∞–±–æ –∑ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è–º–∏)";
          const body = `### üß™ CI-–∑–≤—ñ—Ç

- ${testStatus}
- ${lintStatus}

–ó–≤—ñ—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —è–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏. üéâ`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
